---
# 0. Fail fast
- name: Abort if OS is not supported
  ansible.builtin.fail:
    msg: >
      The 'docker' role only supports: Debian, RedHat, Archlinux, Suse, Alpine.
      Detected: {{ ansible_os_family | default('UNKNOWN') }}
  when:
    - (ansible_os_family is defined)
    - ansible_os_family not in ['Debian', 'RedHat', 'Archlinux', 'Suse', 'Alpine']
  tags: [docker, docker:checks]

# 0.1 Alpine Bootstrap (Instala Python para que se pueda recopilar informaciÃ³n (facts))
# Nota: Esto asume que el playbook tiene gather_facts: false o usas 'gather_subset: min'
# Asegurate de que se pueda ejecutar APKs o utiliza un paso de arranque (bootstrap) previo ejecutado como root.
- name: Bootstrap Python on Alpine (only if needed)
  ansible.builtin.raw: apk add --no-cache python3 py3-pip
  when: ansible_os_family == 'Alpine' and (ansible_python is not defined)
  register: docker_alpine_bootstrap
  changed_when: "'installed' in alpine_bootstrap.stdout or alpine_bootstrap.rc == 0"
  tags: [docker, bootstrap]

# 1. Carga de variables
- name: Load OS-specific variables
  ansible.builtin.include_vars:
    file: "{{ lookup('ansible.builtin.first_found', lookup_params) }}"
  vars:
    lookup_params:
      files:
        - "{{ ansible_distribution }}-{{ ansible_distribution_major_version }}.yml"
        - "{{ ansible_distribution }}.yml"
        - "{{ ansible_os_family }}.yml"
        - "default.yml"
      paths:
        - "{{ role_path }}/vars"
  tags: [docker, docker:vars]

# 2. Instalacion de dependencias previas
- name: Install Docker prerequisites
  ansible.builtin.package:
    name:
      - "{{ docker_curl_package | default('curl') }}"
      - git
      - ca-certificates
      - "{{ docker_python_package | default('python3-docker') }}"
    state: present
  become: true
  tags: [docker, docker:install]

# ---------------------------------------------------------
# BLOQUE DEBIAN / UBUNTU (Gestion segura de Repositorios)
# ---------------------------------------------------------
- name: Setup Docker repository (Debian/Ubuntu)
  when: ansible_os_family == 'Debian'
  become: true
  tags: [docker, docker:repo]
  block:
    - name: Install apt transport packages
      ansible.builtin.apt:
        name: ['apt-transport-https', 'ca-certificates', 'gnupg', 'lsb-release']
        state: present

    - name: Create directory for Docker GPG key
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Download Docker's official GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/{{ docker_repo_distro }}/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
        force: true

    - name: Add Docker repository (Signed)
      ansible.builtin.apt_repository:
        repo: >
          deb [arch={{ docker_arch }} signed-by=/etc/apt/keyrings/docker.asc]
          https://download.docker.com/linux/{{ docker_repo_distro }}
          {{ ansible_distribution_release }} stable
        filename: docker
        state: present
        update_cache: true

# ---------------------------------------------------------
# BLOQUE REDHAT / CENTOS (Gestion de Repositorios)
# ---------------------------------------------------------
- name: Setup Docker repository (RedHat family)
  ansible.builtin.yum_repository:
    name: docker-ce
    description: Docker CE Stable - $basearch
    baseurl: https://download.docker.com/linux/centos/$releasever/$basearch/stable
    enabled: true
    gpgcheck: true
    gpgkey: https://download.docker.com/linux/centos/gpg
  when:
    - ansible_os_family == 'RedHat'
    - docker_configure_repository | default(true)
  become: true
  tags: [docker, docker:repo]
# NOTA: Arch, Suse y Alpine suelen tener Docker en sus repositorios base o community,
# por lo que no configuramos repositorios externos aqui para evitar conflictos.
# 3. Instalacion del plugin Compose
# Caso A: Debian y RedHat (Docker oficial)
- name: Install Docker Engine (Debian/RedHat)
  ansible.builtin.package:
    name: "{{ docker_packages | default(['docker-ce', 'docker-ce-cli', 'containerd.io', 'docker-buildx-plugin', 'docker-compose-plugin']) }}"
    state: present
  when: ansible_os_family in ['Debian', 'RedHat']
  notify: Restart docker
  become: true
  tags: [docker, docker:install]

# Caso B: Archlinux (Community repo)
- name: Install Docker (Arch)
  community.general.pacman:
    name:
      - docker
      - docker-compose
    state: present
  when: ansible_os_family == 'Archlinux'
  notify: Restart docker
  become: true
  tags: [docker, docker:install]

# Caso C: Suse (Zypper)
- name: Install Docker (SUSE)
  community.general.zypper:
    name:
      - docker
      - docker-compose
    state: present
  when: ansible_os_family == 'Suse'
  notify: Restart docker
  become: true
  tags: [docker, docker:install]

# Caso D: Alpine (APK)
- name: Install Docker (Alpine)
  community.general.apk:
    name:
      - docker
      - docker-cli
      - containerd
      - docker-cli-compose # En Alpine a veces es este nombre o docker-compose
    state: present
  when: ansible_os_family == 'Alpine'
  notify: Restart docker
  become: true
  tags: [docker, docker:install]

# 4. Configuracion de seguridad y logs (Daemon)
- name: Configure Docker Daemon (Log Rotation)
  ansible.builtin.copy:
    content: "{{ docker_daemon_options | to_nice_json }}"
    dest: /etc/docker/daemon.json
    mode: '0644'
  notify: Restart docker
  become: true
  tags: [docker, docker:config]

# 5. Gestion de usuarios y servicio
- name: Ensure Docker service is running
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  become: true
  tags: [docker, docker:service]

- name: Add users to docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop: "{{ docker_users | default([ansible_user_id]) }}"
  become: true
  tags: [docker, docker:users]

- name: Reset connection to apply user changes
  ansible.builtin.meta: reset_connection
